import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime, timedelta
import extra_streamlit_components as cookie_manager

# --- 1. DATABASE CONNECTION ---
conn = st.connection("gsheets", type=GSheetsConnection)

# --- 2. PERSISTENT LOGIN (30 Days) ---
controller = cookie_manager.CookieManager()
if "authenticated" not in st.session_state:
    st.session_state["authenticated"] = False

all_cookies = controller.get_all()
if all_cookies and controller.get("bg_prod_login") == "true":
    st.session_state["authenticated"] = True

if not st.session_state["authenticated"]:
    st.title("üè≠ B&G Production: Secure Access")
    pwd = st.text_input("Enter Production Password", type="password")
    if st.button("Log In"):
        if pwd == "BGPROD": 
            st.session_state["authenticated"] = True
            controller.set("bg_prod_login", "true", expires_at=datetime.now() + timedelta(days=30))
            st.rerun()
        else: st.error("Access Denied")
    st.stop()

# --- 3. LOAD MASTER DATA FROM GOOGLE SHEETS ---
# We pull Workers and Jobs from a central sheet to keep everything integrated
try:
    workers_df = conn.read(worksheet="Staff", ttl="5m")
    staff_list = workers_df["Worker_Name"].tolist()
    
    jobs_df = conn.read(worksheet="Jobs", ttl="5m")
    job_list = jobs_df["Job_Code"].tolist()
except:
    # Fallback lists if the specific sheets aren't set up yet
    staff_list = ["Prasanth", "RamaSai", "Subodth", "Naresh", "Ravindra"]
    job_list = ["SSR501", "SSR502", "PROJECT-X"]

# --- 4. MAIN INTERFACE ---
st.title("üè≠ B&G Production Monitor")
tab1, tab2, tab3 = st.tabs(["üìù Daily Entry", "üìä View Records", "‚öôÔ∏è Admin Tool"])

with tab1:
    with st.form("production_form", clear_on_submit=True):
        col1, col2 = st.columns(2)
        with col1:
            worker = st.selectbox("Staff Member", staff_list)
            job = st.selectbox("Job Code", job_list)
        with col2:
            hours = st.number_input("Hours Worked", min_value=0.5, max_value=16.0, step=0.5)
            output_desc = st.text_input("Output Description (e.g., Weld complete)")
        
        if st.form_submit_button("Submit Production Log"):
            new_entry = pd.DataFrame([{
                "Timestamp": datetime.now().strftime('%Y-%m-%d %H:%M'),
                "Worker": worker,
                "Job_Code": job,
                "Hours": hours,
                "Description": output_desc
            }])
            
            # Read existing and append
            existing_data = conn.read(worksheet="Production_Logs")
            updated_df = pd.concat([existing_data, new_entry], ignore_index=True)
            
            # Save to Google Sheets
            conn.update(worksheet="Production_Logs", data=updated_df)
            st.success(f"Log for {worker} saved successfully!")

with tab2:
    st.subheader("Recent Activity")
    try:
        df = conn.read(worksheet="Production_Logs", ttl="0")
        st.dataframe(df.sort_values(by="Timestamp", ascending=False), use_container_width=True)
    except:
        st.info("No production logs found in 'Production_Logs' sheet.")

with tab3:
    st.subheader("‚öôÔ∏è Admin: Resource Management")
    admin_pwd = st.text_input("Enter Master Admin Key", type="password")
    
    if admin_pwd == "BG2026":
        st.write("### Manage Master Lists")
        st.info("To add/remove workers or jobs permanently, edit the 'Staff' or 'Jobs' sheets in your Google Sheet.")
        
        # Quick Link to the Database
        st.link_button("üöÄ Open Master Google Sheet", st.secrets["connections"]["gsheets"]["spreadsheet"])
        
        st.divider()
        st.write("### Data Correction")
        st.warning("To delete incorrect production entries, please edit the 'Production_Logs' sheet directly.")extra-streamlit-components
Pillow
pandas
